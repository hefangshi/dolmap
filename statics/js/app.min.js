var App=App||{};$(document).ready(function(){function i(e){function t(e,t){var r=new BMap.Point(e.x,e.y);var i=5e3;var s=0;var o=0;for(var u=0;u<t.length;u++){var a=t[u];var l=parseInt(a.count,10);if(l<i){i=l}if(l>s){s=l}o+=l}var c=new BMap.Label("任务数:"+o+" 线路数:"+t.length,{position:r});y.addOverlay(c);for(var h=0;h<t.length;h++){var p=t[h];var d=new BMap.Point(p.x,p.y);var v=n([238,199-(p.count-i)/(s-i+1)*199,16]);var m=new BMap.Polyline([r,d],{strokeColor:v,strokeWeight:"4",strokeOpacity:"0.8"});y.addOverlay(m);(function(t){m.addEventListener("click",function(){f(e.city_name,t.route)})})(p)}}function n(e){var t="#";var n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];for(var r=0;r<3;r++){var i=null;var s=e[r];var o=[];while(s>16){i=s%16;s=s/16>>0;o.push(n[i])}o.push(n[s]);t+=o.reverse().join("")}while(t.length<7)t+="0";return t}y.clearOverlays();$.get("api/radiation.php",{city:e},function(e){t(e.start,e.routes)},"json")}function s(e){function o(e,t){function n(e){return $("<span class='city-link' data-name='"+e.route+"' data-x='"+e.x+"' data-y='"+e.y+"'>"+e.route+"</span>")}$("#quest-route").empty();$(t).each(function(t,r){if(r.route_type!=0||r.route==e){$("#quest-route").append(n(r)).append("<span>-></span>")}});$("#quest-route span:last").remove()}function f(){function n(e,t,n){for(var r=t;r<=n;r++){e.append("<option>"+r+"</option>")}}var e=r.find(".toStar,.fromStar");e.empty();n(e,0,10);i.val(0);s.val(10);s.change(function(){var e=parseInt(s.val(),10);var n=parseInt(i.val(),10);if(e<n){n=e}i.val(n);var r=$("#sim-grid-dialog .startSelect").val();u(t,r,i.val(),s.val())});i.change(function(){var e=parseInt(s.val(),10);var n=parseInt(i.val(),10);if(e<n){e=n}s.val(e);var r=$("#sim-grid-dialog .startSelect").val();u(t,r,i.val(),s.val())})}$("#sim-grid-dialog").width(600);var t=e.ID;var n=e.routes[0].route;var r=$("#sim-grid-dialog .modal-body");var i=r.find(".fromStar");var s=r.find(".toStar");a();f();$("#sim-grid-dialog .startSelect").empty();$(".quest-name").html(e.Name);$(e.routes).each(function(e,t){if(t.route_type==0){$("#sim-grid-dialog .startSelect").append("<option>"+t.route+"</option>")}});$("#sim-grid-dialog .startSelect").unbind("change").change(function(){var n=$("#sim-grid-dialog .startSelect").val();u(t,n,i.val(),s.val());o(n,e.routes)});o(n,e.routes);u(t,n,i.val(),s.val());$("#sim-grid-dialog").css({top:0,left:"auto",right:0}).modal("show")}function u(e,t,n,r){o=0;$("#sim-grid").flexOptions({newp:1,params:[{name:"id",value:e},{name:"start",value:t},{name:"fromStar",value:n},{name:"toStar",value:r}]}).flexOptions({preProcess:function(e){o=e.total;$(e.rows).each(function(e,n){if(n.cell.append_route.indexOf(t)===0)return true;n.cell.append_route=t+","+n.cell.append_route});return e},onSubmit:function(){if(o)$("#sim-grid").flexOptions({params:[{name:"total",value:o},{name:"id",value:e},{name:"start",value:t},{name:"fromStar",value:n},{name:"toStar",value:r}]});return true}}).flexReload()}function a(){var e=$("#sim-grid");if(e.css("display")!="none")return;$("#sim-grid").flexigrid({url:"api/simquest.php",dataType:"json",colModel:[{display:"任务名称",name:"name",width:120,sortable:true,align:"center"},{display:"并行代价",name:"value",width:60,sortable:true,align:"left"},{display:"任务星级",name:"star",width:50,sortable:true,align:"center"},{display:"技能要求",name:"skills",width:130,sortable:true,align:"left"},{display:"任务路径",name:"append_route",width:220,sortable:true,align:"left"}],addTitleToCell:true,sortname:"value",sortorder:"asc",usepager:true,useRp:true,rp:15,height:200,autoload:false,pagestat:"显示 {from} 到 {to} 条任务，共 {total} 条",pagetext:"第",outof:"页，共",findtext:"查找",procmsg:"正在获取任务中 ...",nomsg:"未找到任务",singleSelect:true,onDoubleClick:function(e){var t=$(e).attr("id").substring(3);d(t)},onSubmit:function(e){}})}function f(e,t){$("#quest-grid-dialog").width(600);h();$("#quest-grid-dialog .citySearch").on("keyup",function(e){if(e.keyCode!="13")return;var t=$("#quest-grid-dialog .startRoute").val();var n=$("#quest-grid-dialog .endRoute").val();if(t||n)c(t,n)}).change(function(){var e=$("#quest-grid-dialog .startRoute").val();var t=$("#quest-grid-dialog .endRoute").val();if(e||t)c(e,t)});$("#quest-grid-dialog").css({top:0,left:"auto",right:0}).modal("show").on("shown",function(){$(".startRoute").focus()});if(e||t){$("#quest-grid-dialog .startRoute").val(e);$("#quest-grid-dialog .endRoute").val(t);c(e,t)}}function c(e,t){l=0;$("#quest-grid").flexOptions({newp:1,params:[{name:"end",value:t},{name:"start",value:e}]}).flexOptions({preProcess:function(e){l=e.total;return e},onSubmit:function(){if(l)$("#quest-grid").flexOptions({params:[{name:"total",value:l},{name:"end",value:t},{name:"start",value:e}]});return true}}).flexReload()}function h(){var e=$("#quest-grid");if(e.css("display")!="none")return;$("#quest-grid").flexigrid({url:"api/questSearch.php?method=filterSearch",dataType:"json",colModel:[{display:"任务名称",name:"name",width:120,sortable:true,align:"center"},{display:"任务星级",name:"star",width:50,sortable:true,align:"center"},{display:"技能要求",name:"skills",width:130,sortable:true,align:"left"},{display:"任务起点",name:"start",width:100,sortable:true,align:"left"},{display:"任务路径",name:"append_route",width:220,sortable:true,align:"left"}],addTitleToCell:true,sortname:"star",sortorder:"desc",usepager:true,useRp:true,rp:15,height:200,autoload:false,pagestat:"显示 {from} 到 {to} 条任务，共 {total} 条",pagetext:"第",outof:"页，共",findtext:"查找",procmsg:"正在获取任务中 ...",nomsg:"未找到任务",singleSelect:true,onDoubleClick:function(e){var t=$(e).attr("id").substring(3);d(t)}})}function p(e,t,r){function i(e){var t="#"+e;if($(t).length!==0){$(t).collapse("show");return}var n=$("<div></div>").addClass("accordion-group");var r=$("<div></div>").addClass("accordion-heading").appendTo(n);var i=$("<a></a>").addClass("accordion-toggle").attr({"data-toggle":"collapse","data-parent":"#cityInfoPanel",href:t}).html(e).appendTo(r);var s=$("<div></div>").addClass("accordion-body collapse").attr("id",e).appendTo(n);var o=$("<div></div>").addClass("accordion-inner").appendTo(s);$("<input class='btn btn-primary btn-mini city-route-btn' type='button' value='任务辐射'/>").data("city",e).appendTo(o);$("<input class='btn btn-mini city-quest-btn' type='button' value='查找任务'/>").data("city",e).appendTo(o);n.appendTo("#cityInfoPanel");$(t).collapse({parent:"#cityInfoPanel"});$(t).collapse("show")}function s(e,t){var r=new BMap.Point(e,t);var i=Math.max(8,y.getZoom());y.centerAndZoom(r,i);if(n){y.removeOverlay(n);n=null}n=new BMap.Marker(r);n.setOffset(new BMap.Size(5,5));y.addOverlay(n);n.setAnimation(BMAP_ANIMATION_BOUNCE);setTimeout(function(){n.setAnimation(null)},2e3)}s(e,t);i(r)}function d(e){function n(e){var t={};var n=true;var r=[];var i=[];y.clearOverlays();for(var s=0;s<e.routes.length;s++){var o=e.routes[s];var u=new BMap.Point(o.x,o.y);i.push(u);if(o.route_type=="0"){t[o.route]=[];t[o.route].push(u);var a=new BMap.Marker(u,{offset:new BMap.Size(5,5)});a.setLabel(new BMap.Label("起点"));y.addOverlay(a)}else if(n){n=false;for(var f in t){t[f].push(u);y.addOverlay(new BMap.Polyline(t[f],{strokeColor:"yellow",strokeWeight:"3"}));r.push(u)}}else{r.push(u)}if(s==e.routes.length-1){var a=new BMap.Marker(u,{offset:new BMap.Size(5,5)});a.setLabel(new BMap.Label("终点"));y.addOverlay(a)}}y.addOverlay(new BMap.Polyline(r,{strokeColor:"red",strokeWeight:"3"}));y.setViewport(i,{zoomFactor:-1})}var t="#info_panel_"+e;if($(t).length!==0){$(t).collapse("show");return}$(".friends").hide();$.get("/api/questSearch.php",{method:"queryInfo",id:e},function(r){var i=$("<div></div>").addClass("accordion-group");var s=$("<div></div>").addClass("accordion-heading").appendTo(i);var o=$("<a></a>").addClass("accordion-toggle").attr({"data-toggle":"collapse","data-parent":"#questInfoPanel",href:t}).html(r.Name).appendTo(s);var u=$("<div></div>").addClass("accordion-body collapse").attr("id","info_panel_"+e).appendTo(i);var a=$("<div></div>").addClass("accordion-inner").appendTo(u);$("<div class='quest-star'></div>").html("<b>星级：</b>"+r.Star+"★").appendTo(a);var f=$("<div class='quest-award'></div>").append("<div><b>奖励：</b>"+r.Exp+"EXP/"+r.Fame+"FAME </div>").appendTo(a);if(r.Discovery)$("<div class='quest-discvoery'></div>").append("<b>发现物：</b>"+r.DiscoveryType+"  "+r.DiscoveryLevel+"★  "+r.Discovery).appendTo(a);if(r.routes.length>0){var l=$("<div class='quest-accept'></div>").html("<b>接受地点：</b>").appendTo(a);$(r.routes).each(function(e,t){if(t.route_type==0){var n=$("<div><span class='city-link'>"+t.route+"</span></div>").data("data",t);l.append(n);$("span",n).click(function(e){var t=$(e.target).parent().data("data");p(t.x,t.y,t.route)})}})}if(r.AwardItem)f.append("<div>"+r.AwardItem+"</div>");if(r.PreFound)$("<div><b>前置发现：</b>"+r.PreFound+"</div>").appendTo(a);var c=$("<div><b>技能要求：</b></div>").appendTo(a);if(r.skills.length>0){$(r.skills).each(function(e,t){c.append("<span>"+t.skill+" : "+t.level+"  </span>")})}if(r.relation.length>0){var h=$("<div class='pre-quest'><b>前置：</b></div>");var v=$("<div class='follow-quest'><b>后续：</b></div>");var m=false;var g=false;$(r.relation).each(function(e,t){var n=$("<div><span class='quest-link'>"+t.name+"</span></div>").data("id",t.id);if(t.relation_type==0){m=true;h.append(n)}else if(t.relation_type==1){g=true;v.append(n)}$("span",n).click(function(e){d($(e.target).parent().data("id"))})});m&&a.append(h);g&&a.append(v)}var y=unescape(r.Content);var b={};$(r.routes).each(function(e,t){if(b[t.route])return true;b[t.route]=true;var n=new RegExp("("+t.route+")","g");y=y.replace(n,"<span class='city-link' data-name='"+t.route+"' data-x='"+t.x+"' data-y='"+t.y+"'>$1</span>")});var w=/([2-9|二|三|四|五|六|七|八|２|３|４|５|６|７|８|９])次/g;y=y.replace(w,"<span class='important'>$1</span>次");w=/[×|x](\d)/g;y=y.replace(w,"<span class='important'>$1</span>次");var E=$("<div class='quest-content'></div>").append("<div><b>任务流程：</b></div>").append("<div>"+y+"</div>").appendTo(a);var S="";$(".city-link",E).each(function(e,t){t=$(t);if(e!==0&&S!=t.text())return false;S=t.text();$(r.routes).each(function(e,n){if(n.route_type==0){if(n.route==t.text()){t.nextAll("br:first").before("<span class='important'>！</span>")}}})});if(r.routes.length>1&&r.routes[0].route_type==0){$("<input class='btn btn-primary btn-mini dig-btn' type='button' value='查找顺路'/>").data("questInfo",r).prependTo(a)}i.appendTo("#questInfoPanel");$(t).collapse({parent:"#questInfoPanel"});$(t).on("shown",function(){(function(e){n(e)})(r)});$(t).collapse("show")})}function v(){$(".main").children("div").height($(window).height())}function m(){var e=new BMap.TileLayer;var t=["http://dolmap.sinaapp.com/tiles/","http://dolmap.duapp.com/tiles/"];t = t[Math.round(Math.random())];e.getTilesUrl=function(e,r){var i=e.x;var s=e.y;var o=Math.pow(2,r-n.getMinZoom());var u=-o;var a=2*o;while(i>=o)i-=a;while(i<u)i+=a;return t+r+"/tile"+i+"_"+s+".png"};var n=new BMap.MapType("MyMap",e,{minZoom:5,maxZoom:8});var r=new BMap.Map("map",{mapType:n,enableAutoResize:true});r.addControl(new BMap.NavigationControl({showZoomInfo:false}));r.centerAndZoom(new BMap.Point(24,.4),7);r.enableScrollWheelZoom();r.enableInertialDragging();return r}function g(){var e={};var t=null;$(".modal-title").click(function(){$(this).parent().parent().find(".modal-body,.modal-footer").toggle()});$(".quest-search-btn").click(function(){f()});$(".citySearch").typeahead({source:function(t,n){$.get("/api/search.php",{kw:t},function(t){var r=[];e={};$(t).each(function(t,n){r.push(n.city_name);e[n.city_name]=n});n(r)})},matcher:function(){return true},items:10}).change(function(){var t=e[$(this).val()];if(!t)return;else $(this).trigger("selected",t)});$("#searchPosition .citySearch").on("selected",function(e,t){p(t.x,t.y,t.city_name)});var n;$("#questSearch").typeahead({source:function(e,t){function i(){$.get("/api/questSearch.php",{method:"queryList",kw:e},function(e){var n=[];$(e).each(function(e,t){var i=new r(t,t.name);n.push(i)});t(n)})}if(n)window.clearTimeout(n);n=window.setTimeout(i,200)},matcher:function(){return true},updater:function(e){$("#questSearch").select();d(e.item.id);return e.value},items:15}).focus();$(".quest-clear-btn").click(function(){$("#questInfoPanel").empty();$("#questSearch").val("");max_quest_height=0});$(".update-info-btn").click(function(e){$("#update-modal").modal("show")});$(".quest-content .city-link,#quest-route .city-link").live("click",function(e){var t=$(e.currentTarget);p(t.attr("data-x"),t.attr("data-y"),t.attr("data-name"))});$("#questInfoPanel .dig-btn").live("click",function(e){var t=$(e.currentTarget);var n=t.data("questInfo");s(n)});$("#cityInfoPanel .city-quest-btn").live("click",function(e){var t=$(e.currentTarget);var n=t.data("city");f(n)});$("#cityInfoPanel .city-route-btn").live("click",function(e){$(this).toggle(function(){var e=$(this);var t=e.data("city");i(t);e.val("隐藏辐射")},function(){y.clearOverlays();$(this).val("任务辐射")}).trigger("click")});$(".city-clear-btn").click(function(){$("#cityInfoPanel").empty()})}var e=null;var t=this;var n=null;var r=function(e,t){this.item=e;this.value=t;this.length=this.value.length};r.prototype={toString:function(){return this.value},toLowerCase:function(){return String.prototype.toLowerCase.apply(this.value)},indexOf:function(e){return String.prototype.indexOf.apply(this.value,arguments)},replace:function(){return String.prototype.replace.apply(this.value,arguments)}};var o=0;var l=0;v();g();var y=m()})